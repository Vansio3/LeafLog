<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LeafLog - Tree Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: 10; height: 50px; }

        /* FAB General Styles */
        .fab {
            background-color: #16a34a; color: white; width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s ease; border: none;
        }
        .fab:hover { background-color: #15803d; }
        .fab:active { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transform: translateY(1px); }
        .fab i { font-size: 24px; transition: transform 0.3s ease; }

        /* Locate FAB Container */
        .locate-fab-container {
            position: fixed;
            bottom: 80px; /* Adjust base position */
            right: 15px;
            z-index: 1000;
        }
        .fab-secondary { /* Style for locate button */
            background-color: #ffffff; color: #374151; width: 48px; height: 48px;
        }
        .fab-secondary:hover { background-color: #f3f4f6; }
        .fab-secondary i { font-size: 20px; }

        /* Add FAB Container & Expansion */
        #add-fab-container {
            position: fixed;
            bottom: 140px; /* Position above locate FAB */
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px; /* Space when expanded */
        }

        /* Main Add FAB */
        #add-tree-fab {
            position: relative; /* Needed for absolute positioning of sub-fabs if needed */
            z-index: 1001; /* Above sub-fabs when collapsed */
        }
        /* Rotate icon when expanded */
        #add-fab-container.expanded #add-tree-fab i {
            transform: rotate(45deg);
        }

        /* Sub FABs (Spotted/Planted) */
        .sub-fab {
            width: 45px; height: 45px; font-size: 0.8em; font-weight: 600;
            position: absolute; /* Position relative to container */
            bottom: 5px; /* Align near bottom of main FAB */
            right: 5px;
            z-index: 1000;
            opacity: 0;
            transform: scale(0.5) translateY(10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            cursor: grab; /* Indicate draggable */
            pointer-events: none; /* Prevent interaction when hidden */
            display: flex; /* Use flex for icon + text */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            text-align: center;
            line-height: 1.1;
        }
        .sub-fab i { font-size: 16px; margin-bottom: 1px; }

        #add-fab-container.expanded .sub-fab {
            position: relative; /* Change to relative when expanded to use flex gap */
            bottom: auto;
            right: auto;
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto; /* Allow interaction when visible */
        }

        /* Specific Sub-FAB styles */
        #sub-fab-spotted { background-color: #fbbf24; /* amber-400 */ color: #422006; }
        #sub-fab-planted { background-color: #3b82f6; /* blue-500 */ color: white; }
        #sub-fab-spotted:hover { background-color: #f59e0b; }
        #sub-fab-planted:hover { background-color: #2563eb; }

        /* Style for element being dragged */
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
        }


        /* Bottom Sheet (styles remain largely the same) */
        #bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15); z-index: 1001; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); max-height: 90vh; display: flex; flex-direction: column; }
        #bottom-sheet.active { transform: translateY(0); }
        #bottom-sheet.state-handle { transform: translateY(calc(100% - 60px)); }
        #bottom-sheet.state-form { transform: translateY(0); }
        #bottom-sheet.state-list-partial { transform: translateY(40%); }
        #bottom-sheet.state-list-full { transform: translateY(10%); }
        .bottom-sheet-handle { padding: 10px; text-align: center; cursor: grab; border-bottom: 1px solid #eee; }
        .bottom-sheet-handle-bar { width: 40px; height: 5px; background-color: #d1d5db; border-radius: 3px; margin: 0 auto; }
        .bottom-sheet-content { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .bottom-sheet-view { display: none; }
        .bottom-sheet-view.visible { display: block; }
        .bottom-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
        .bottom-sheet-header h3 { font-size: 1.2rem; font-weight: 600; color: #333; margin: 0; }
        .bottom-sheet-back-btn, .bottom-sheet-close-btn { background: none; border: none; font-size: 1.3rem; color: #6b7280; cursor: pointer; padding: 5px; }
        .main-menu-button { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; cursor: pointer; background-color: white; transition: background-color 0.2s; }
        .main-menu-button:hover { background-color: #f9fafb; }
        .main-menu-button h4 { font-weight: 500; margin: 0; color: #374151; }
        .main-menu-button .count-badge { background-color: #e0e0e0; color: #555; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .main-menu-button i.fa-chevron-right { color: #aaa; }
        .list-item { padding: 10px 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .list-item .view-on-map-btn { background: none; border: none; color: #3498db; cursor: pointer; font-size: 0.9em; margin-left: 8px; padding: 0.25rem; white-space: nowrap; }
        .list-item .view-on-map-btn:hover { text-decoration: underline; }
        #add-form-view { padding-top: 0; }
        #add-form-view form { margin-top: 0; }
        .popup-image { max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px; margin-top: 8px; }
        .leaflet-popup-content { min-width: 220px; }
        .current-location-marker { background-color: rgba(51, 133, 255, 0.4); border: 2px solid #3385ff; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Print Styles */
        @media print {
             body, html { height: auto; overflow: visible; }
            #map { height: 95vh !important; page-break-inside: avoid; width: 100% !important; }
            .no-print { display: none !important; }
            .header { position: relative !important; }
            #bottom-sheet, .locate-fab-container, #add-fab-container { display: none !important; }
            .current-location-marker { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-green-700 text-white p-3 shadow-md header no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-leaf mr-1"></i>LeafLog</h1>
        </div>
    </header>

    <div id="map"></div>

    <!-- Locate FAB -->
    <div class="locate-fab-container no-print">
         <button id="locate-fab" class="fab fab-secondary" aria-label="Center on my location">
             <i class="fas fa-location-arrow"></i>
         </button>
    </div>

    <!-- Add FAB Container -->
    <div id="add-fab-container" class="no-print">
         <!-- Sub FABs (hidden initially, appear on expand) -->
         <button id="sub-fab-spotted" class="fab sub-fab" draggable="true" data-tree-type="Spotted">
             <i class="fas fa-binoculars"></i>Spot
         </button>
         <button id="sub-fab-planted" class="fab sub-fab" draggable="true" data-tree-type="Planted">
             <i class="fas fa-seedling"></i>Plant
         </button>
        <!-- Main Add FAB -->
        <button id="add-tree-fab" class="fab" aria-label="Add new tree">
            <i class="fas fa-plus"></i>
        </button>
    </div>


    <!-- Bottom Sheet (HTML structure remains the same) -->
    <div id="bottom-sheet" class="no-print">
         <div class="bottom-sheet-handle"><div class="bottom-sheet-handle-bar"></div></div>
         <div class="bottom-sheet-content">
             <!-- Main Menu View -->
             <div id="main-menu-view" class="bottom-sheet-view visible"> <!-- ... content ... -->
                 <h3 class="text-lg font-semibold mb-4 text-gray-800">Explore & Add</h3>
                 <button class="main-menu-button" data-view-target="spotted-list-view"><h4>Spotted Trees</h4><div><span id="spotted-count" class="count-badge">0</span><i class="fas fa-chevron-right ml-2"></i></div></button>
                 <button class="main-menu-button" data-view-target="planted-list-view"><h4>Planted Trees</h4><div><span id="planted-count" class="count-badge">0</span><i class="fas fa-chevron-right ml-2"></i></div></button>
                 <button class="main-menu-button" data-view-target="reminders-list-view"><h4>Reminders</h4><div><span id="reminder-count" class="count-badge">0</span><i class="fas fa-chevron-right ml-2"></i></div></button>
             </div>
             <!-- Spotted List View -->
             <div id="spotted-list-view" class="bottom-sheet-view"> <!-- ... header + list ... -->
                  <div class="bottom-sheet-header"><button class="bottom-sheet-back-btn" aria-label="Back to menu"><i class="fas fa-arrow-left"></i></button><h3>Spotted Trees</h3><button class="bottom-sheet-close-btn" aria-label="Close sheet"><i class="fas fa-times"></i></button></div><ul id="spotted-list" class="list-item-container"></ul>
             </div>
             <!-- Planted List View -->
             <div id="planted-list-view" class="bottom-sheet-view"> <!-- ... header + list ... -->
                  <div class="bottom-sheet-header"><button class="bottom-sheet-back-btn" aria-label="Back to menu"><i class="fas fa-arrow-left"></i></button><h3>Planted Trees</h3><button class="bottom-sheet-close-btn" aria-label="Close sheet"><i class="fas fa-times"></i></button></div><ul id="planted-list" class="list-item-container"></ul>
             </div>
             <!-- Reminders List View -->
              <div id="reminders-list-view" class="bottom-sheet-view"> <!-- ... header + list ... -->
                   <div class="bottom-sheet-header"><button class="bottom-sheet-back-btn" aria-label="Back to menu"><i class="fas fa-arrow-left"></i></button><h3>Reminders</h3><button class="bottom-sheet-close-btn" aria-label="Close sheet"><i class="fas fa-times"></i></button></div><ul id="reminders-list" class="list-item-container"></ul>
              </div>
             <!-- Add Form View -->
             <div id="add-form-view" class="bottom-sheet-view"> <!-- ... header + form ... -->
                  <div class="bottom-sheet-header"><span></span><h3>Add New Tree</h3><button class="bottom-sheet-close-btn" aria-label="Cancel add tree"><i class="fas fa-times"></i></button></div>
                  <form id="tree-form" class="space-y-4">
                     <input type="hidden" id="lat" name="lat"><input type="hidden" id="lng" name="lng">
                     <div><label for="type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label><select id="type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-100" disabled><option value="Spotted">Spotted</option><option value="Planted">Planted</option></select></div> {/* Disabled type */}
                     <div><label for="species" class="block text-sm font-medium text-gray-700 mb-1">Species *</label><input type="text" id="species" name="species" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Oak, Maple"></div>
                     <div><label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label><textarea id="notes" name="notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Observations..."></textarea></div>
                     <div><label for="image" class="block text-sm font-medium text-gray-700 mb-1">Photo</label><input type="file" id="image" name="image" accept="image/*" class="w-full px-3 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"><div id="image-preview" class="mt-2 hidden"><img id="preview-img" src="#" alt="Preview" class="h-32 object-cover rounded-md"></div></div>
                     <div class="flex justify-end space-x-3 pt-2"><button type="button" id="cancel-form-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Save Tree</button></div>
                  </form>
             </div>
         </div>
    </div>

    <!-- Notification (remains the same) -->
    <div id="notification" class="fixed top-16 right-4 bg-green-500 text-white p-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full no-print" style="z-index: 1002;">
        <p id="notification-text" class="text-sm"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- Map, Geolocation, Refs (mostly same) ---
        const defaultCoords = [42.501511, 27.466138];
        const map = L.map('map', { zoomControl: false }).setView(defaultCoords, 13);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM', maxZoom: 19 }).addTo(map);

        let currentLocationMarker = null;
        let lastKnownLocation = null;
        let centeredOnLocation = false;
        // Geolocation watchPosition logic remains the same...
        if (navigator.geolocation) { navigator.geolocation.watchPosition( (pos) => { const lat=pos.coords.latitude, lng=pos.coords.longitude; lastKnownLocation=[lat,lng]; if(!currentLocationMarker){ currentLocationMarker=L.circleMarker(lastKnownLocation, {radius:8, className:'current-location-marker'}).addTo(map).bindPopup("Your location"); } else { currentLocationMarker.setLatLng(lastKnownLocation); } if(!centeredOnLocation){ map.setView(lastKnownLocation, 16); centeredOnLocation=true; if(currentLocationMarker) currentLocationMarker.openPopup(); } }, (err) => { console.error("Geo Err: ", err.message); if(!centeredOnLocation)map.setView(defaultCoords, 13); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); } else { console.log("Geo not supported."); }

        // --- DOM References ---
        const bottomSheet = document.getElementById('bottom-sheet'); /* ... other sheet refs */
        const allSheetViews = bottomSheet.querySelectorAll('.bottom-sheet-view');
        const mainMenuButtons = document.querySelectorAll('#main-menu-view .main-menu-button');
        const backButtons = bottomSheet.querySelectorAll('.bottom-sheet-back-btn');
        const closeButtons = bottomSheet.querySelectorAll('.bottom-sheet-close-btn');
        const locateFab = document.getElementById('locate-fab');
        const addFabContainer = document.getElementById('add-fab-container'); // Container for add FABs
        const addTreeFab = document.getElementById('add-tree-fab'); // Main add FAB
        const subFabs = addFabContainer.querySelectorAll('.sub-fab'); // Spotted/Planted FABs
        const mapContainer = document.getElementById('map'); // Map element for drop events

        // Form elements
        const treeForm = document.getElementById('tree-form');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const typeSelect = document.getElementById('type'); // Get the type select element
        const imageInput = document.getElementById('image');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const cancelFormBtn = document.getElementById('cancel-form-btn');

        // List containers & counts refs...
        const spottedList = document.getElementById('spotted-list'); /* etc. */
        const plantedList = document.getElementById('planted-list');
        const remindersList = document.getElementById('reminders-list');
        const spottedCountBadge = document.getElementById('spotted-count');
        const plantedCountBadge = document.getElementById('planted-count');
        const reminderCountBadge = document.getElementById('reminder-count');


        const notification = document.getElementById('notification');

        // --- State Variables ---
        let trees = JSON.parse(localStorage.getItem('leaflog_trees') || '[]');
        let markers = {};
        // Remove isAddMode state: let isAddMode = false;
        let currentBottomSheetView = 'main-menu-view';
        let currentBottomSheetState = 'state-handle';

        // --- Bottom Sheet Management (remains the same) ---
        function setBottomSheetState(newState, viewId = null) { bottomSheet.classList.remove('state-handle', 'state-form', 'state-list-partial', 'state-list-full', 'active'); if (newState === 'closed'){ currentBottomSheetState = 'closed'; } else { bottomSheet.classList.add('active', newState); currentBottomSheetState = newState; if (viewId) showBottomSheetView(viewId); } }
        function showBottomSheetView(viewId) { allSheetViews.forEach(v => v.classList.toggle('visible', v.id === viewId)); currentBottomSheetView = viewId; bottomSheet.querySelector('.bottom-sheet-content').scrollTop = 0; }
        setBottomSheetState('state-handle', 'main-menu-view'); // Initial state
        bottomSheet.querySelector('.bottom-sheet-handle').addEventListener('click', () => { if (currentBottomSheetState === 'state-handle') { setBottomSheetState(currentBottomSheetView === 'main-menu-view' ? 'state-list-partial' : 'state-list-full', currentBottomSheetView); } else if (currentBottomSheetState === 'state-list-partial') { setBottomSheetState('state-list-full', currentBottomSheetView); } else { setBottomSheetState('state-handle', 'main-menu-view'); } });
        mainMenuButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('state-list-full', b.dataset.viewTarget)));
        backButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('state-list-partial', 'main-menu-view')));
        closeButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('closed')));

        // --- FAB Interaction ---

        // Locate Button (remains same)
        locateFab.addEventListener('click', () => { if (lastKnownLocation) { map.setView(lastKnownLocation, 16, { animate: true }); if (currentLocationMarker) currentLocationMarker.openPopup(); } else { showNotification("Current location not available."); } });

        // Add FAB Expansion/Collapse
        addTreeFab.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click bubbling to document listener
            addFabContainer.classList.toggle('expanded');
            // Close bottom sheet if FAB is expanded
            if (addFabContainer.classList.contains('expanded')) {
                 setBottomSheetState('closed');
            }
        });

        // Collapse Add FAB if clicking outside
        document.addEventListener('click', (e) => {
            if (!addFabContainer.contains(e.target) && addFabContainer.classList.contains('expanded')) {
                addFabContainer.classList.remove('expanded');
            }
        });


        // --- Drag and Drop Logic ---

        // Add dragstart listeners to sub-FABs
        subFabs.forEach(fab => {
            fab.addEventListener('dragstart', (e) => {
                const treeType = fab.dataset.treeType;
                e.dataTransfer.setData('text/plain', treeType);
                e.dataTransfer.effectAllowed = 'copy'; // Indicate copying data
                fab.classList.add('dragging'); // Style the dragged element
                // Optional: Set a custom drag image if needed
                // const dragIcon = document.createElement('div'); ... e.dataTransfer.setDragImage(dragIcon, 10, 10);
                setTimeout(() => addFabContainer.classList.remove('expanded'), 0); // Collapse main FAB immediately after drag starts
            });

            fab.addEventListener('dragend', (e) => {
                fab.classList.remove('dragging'); // Clean up style
            });
        });

        // Add dragover listener to map container
        mapContainer.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'copy'; // Visual cue
        });

        // Add drop listener to map container
        mapContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const treeType = e.dataTransfer.getData('text/plain');

            if (treeType === 'Spotted' || treeType === 'Planted') {
                // Convert mouse event coordinates to LatLng
                const latLng = map.mouseEventToLatLng(e);

                // Open the form with pre-filled data
                openAddForm(latLng.lat, latLng.lng, treeType);
            } else {
                console.warn("Invalid data dropped:", treeType);
            }
        });


        // --- Form Handling ---

        // NEW function to open form with pre-filled type
        function openAddForm(lat, lng, treeType) {
            latInput.value = lat;
            lngInput.value = lng;
            typeSelect.value = treeType; // Set the value of the select element
             // typeSelect.disabled = true; // Keep it disabled so user cannot change it

            // Reset other fields visually (optional, depends if you want previous data kept)
            document.getElementById('species').value = '';
            document.getElementById('notes').value = '';
            imageInput.value = null; // Clear file input
            imagePreview.classList.add('hidden');

            setBottomSheetState('state-form', 'add-form-view');
            document.getElementById('species').focus(); // Focus species field
        }

        // Cancel button inside the form (remains same)
        cancelFormBtn.addEventListener('click', () => { setBottomSheetState('closed'); treeForm.reset(); imagePreview.classList.add('hidden'); });

        // Form Submission (logic remains same, type is read from disabled select)
         treeForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const lat = parseFloat(latInput.value);
              const lng = parseFloat(lngInput.value);
              const type = typeSelect.value; // Read value from the (potentially disabled) select
              const species = document.getElementById('species').value;
              const notes = document.getElementById('notes').value;
              const imageFile = imageInput.files[0];
              let imageDataUrl = '';

              function saveTreeData() { /* ... same saving logic ... */
                   const tree = { id: Date.now().toString(), type, species, notes, location: { lat, lng }, imageUrl: imageDataUrl, dateAdded: new Date().toISOString(), needsAttention: false };
                   trees.push(tree);
                   saveTreesToLocalStorage();
                   addTreeMarker(tree);
                   populateLists();
                   setBottomSheetState('closed');
                   treeForm.reset(); imagePreview.classList.add('hidden');
                   showNotification('Tree added successfully!');
              }
              if (imageFile) { const reader = new FileReader(); reader.onload = (e) => { imageDataUrl = e.target.result; saveTreeData(); }; reader.readAsDataURL(imageFile); } else { saveTreeData(); }
         });

        // --- Image Preview, Local Storage, Markers, Popups, Reminders (remain same) ---
        imageInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (e) => { previewImg.src = e.target.result; imagePreview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { imagePreview.classList.add('hidden'); } });
        function saveTreesToLocalStorage() { localStorage.setItem('leaflog_trees', JSON.stringify(trees)); }
        function addTreeMarker(tree) { const marker = L.marker([tree.location.lat, tree.location.lng]).addTo(map); markers[tree.id] = marker; marker.bindPopup(() => createPopupContent(tree)); marker.on('popupopen', () => attachReminderButtonListener(tree.id)); }
        function createPopupContent(tree) { /* ... same ... */ const rbt=tree.needsAttention?'Remove Reminder':'Add Reminder'; const rbc=tree.needsAttention?'bg-yellow-500 hover:bg-yellow-600':'bg-blue-500 hover:bg-blue-600'; let c=`<div class="popup-content"><h3 class="text-lg font-semibold">${tree.species}</h3><p class="text-sm text-gray-600"><strong>Type:</strong> ${tree.type}</p>`; if(tree.notes)c+=`<p class="text-sm mt-1"><strong>Notes:</strong> ${tree.notes}</p>`; if(tree.imageUrl)c+=`<img src="${tree.imageUrl}" alt="${tree.species}" class="popup-image mt-2">`; c+=`<button class="toggle-reminder-btn text-xs text-white px-2 py-1 rounded mt-3 ${rbc}" data-tree-id="${tree.id}"><i class="fas ${tree.needsAttention?'fa-bell-slash':'fa-bell'} mr-1"></i>${rbt}</button></div>`; return c; }
        function attachReminderButtonListener(treeId) { /* ... same ... */ const b=document.querySelector(`.toggle-reminder-btn[data-tree-id="${treeId}"]`); if(b){b.removeEventListener('click',handleReminderToggle); b.addEventListener('click',handleReminderToggle);} }
        function handleReminderToggle(event) { /* ... same ... */ const b=event.target.closest('button'); const tId=b.getAttribute('data-tree-id'); const tIdx=trees.findIndex(t=>t.id===tId); if(tIdx!==-1){trees[tIdx].needsAttention=!trees[tIdx].needsAttention; saveTreesToLocalStorage(); const m=markers[tId]; if(m&&m.isPopupOpen()){m.setPopupContent(createPopupContent(trees[tIdx])); attachReminderButtonListener(tId);} populateLists(); showNotification(trees[tIdx].needsAttention?'Reminder added!':'Reminder removed.');} }

        // --- List Population (remains same) ---
        function populateLists() { /* ... same logic as previous version ... */ spottedList.innerHTML=''; plantedList.innerHTML=''; remindersList.innerHTML=''; let sc=0, pc=0, rc=0; const sorted = [...trees].sort((a,b)=>a.species.localeCompare(b.species)); sorted.forEach(tree => { const itemHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-tree mr-2 ${tree.type==='Planted'?'text-blue-600':'text-green-600'}"></i><span class="font-medium">${tree.species}</span>${tree.notes?`<span class="text-xs text-gray-500 block ml-5 truncate" title="${tree.notes}">(${tree.notes.substring(0,30)}${tree.notes.length>30?'...':''})</span>`:''}</span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`; const action = ()=>{ const targetTree=trees.find(t=>t.id===tree.id); if(targetTree){ setBottomSheetState('closed'); map.setView(targetTree.location, 17, {animate:true}); setTimeout(()=>{if(markers[targetTree.id]) markers[targetTree.id].openPopup();}, 300); }}; const listItem=document.createElement('li');listItem.className='list-item';listItem.innerHTML=itemHTML; listItem.querySelector('.view-on-map-btn').addEventListener('click',action); if(tree.type==='Spotted'){spottedList.appendChild(listItem); sc++;} else if(tree.type==='Planted'){plantedList.appendChild(listItem); pc++;} if(tree.needsAttention){const reminderItem=document.createElement('li');reminderItem.className='list-item';reminderItem.innerHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-bell mr-2 text-orange-500"></i><span class="font-medium">${tree.species}</span> <span class="text-xs text-gray-500">(${tree.type})</span></span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`;reminderItem.querySelector('.view-on-map-btn').addEventListener('click',action);remindersList.appendChild(reminderItem);rc++;}}); spottedCountBadge.textContent=sc; plantedCountBadge.textContent=pc; reminderCountBadge.textContent=rc; const placeholderHTML='<li class="text-gray-500 italic p-4 text-center">Nothing here yet.</li>'; if(sc===0)spottedList.innerHTML=placeholderHTML; if(pc===0)plantedList.innerHTML=placeholderHTML; if(rc===0)remindersList.innerHTML=placeholderHTML; }

        // --- Notification (same) ---
        function showNotification(message) { document.getElementById('notification-text').textContent=message; notification.classList.remove('translate-x-full'); notification.classList.add('translate-x-0'); setTimeout(()=>{notification.classList.remove('translate-x-0'); notification.classList.add('translate-x-full');},3000); }

        // --- Initialization (same) ---
        function initializeApp() { loadExistingTrees(); populateLists(); setBottomSheetState('state-handle', 'main-menu-view'); }
        function loadExistingTrees() { trees.forEach(tree => { if (tree.needsAttention === undefined) tree.needsAttention = false; addTreeMarker(tree); }); }
        initializeApp();

    </script>
</body>
</html>