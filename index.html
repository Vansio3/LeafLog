<!DOCTYPE html>
<!-- ... (head, body, header, map div, FABs, Bottom Sheet HTML remains the same as the previous Drag & Drop version) ... -->

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- Map, Geolocation, Refs (mostly same) ---
        const defaultCoords = [42.501511, 27.466138];
        const map = L.map('map', { zoomControl: false }).setView(defaultCoords, 13);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM', maxZoom: 19 }).addTo(map);

        let currentLocationMarker = null;
        let lastKnownLocation = null;
        let centeredOnLocation = false;
        // Geolocation logic...
        if (navigator.geolocation) { navigator.geolocation.watchPosition( (pos) => { const lat=pos.coords.latitude, lng=pos.coords.longitude; lastKnownLocation=[lat,lng]; if(!currentLocationMarker){ currentLocationMarker=L.circleMarker(lastKnownLocation, {radius:8, className:'current-location-marker'}).addTo(map).bindPopup("Your location"); } else { currentLocationMarker.setLatLng(lastKnownLocation); } if(!centeredOnLocation){ map.setView(lastKnownLocation, 16); centeredOnLocation=true; if(currentLocationMarker) currentLocationMarker.openPopup(); } }, (err) => { console.error("Geo Err: ", err.message); if(!centeredOnLocation)map.setView(defaultCoords, 13); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); } else { console.log("Geo not supported."); }

        // --- DOM References ---
        const bottomSheet = document.getElementById('bottom-sheet');
        const allSheetViews = bottomSheet.querySelectorAll('.bottom-sheet-view');
        const mainMenuButtons = document.querySelectorAll('#main-menu-view .main-menu-button');
        const backButtons = bottomSheet.querySelectorAll('.bottom-sheet-back-btn');
        const closeButtons = bottomSheet.querySelectorAll('.bottom-sheet-close-btn');
        const locateFab = document.getElementById('locate-fab');
        const addFabContainer = document.getElementById('add-fab-container');
        const addTreeFab = document.getElementById('add-tree-fab');
        const subFabs = addFabContainer.querySelectorAll('.sub-fab');
        const mapContainer = document.getElementById('map'); // Explicit reference to the map DIV

        // Form elements...
        const treeForm = document.getElementById('tree-form');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const typeSelect = document.getElementById('type');
        const imageInput = document.getElementById('image');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const cancelFormBtn = document.getElementById('cancel-form-btn');

        // List containers & counts refs...
        const spottedList = document.getElementById('spotted-list');
        const plantedList = document.getElementById('planted-list');
        const remindersList = document.getElementById('reminders-list');
        const spottedCountBadge = document.getElementById('spotted-count');
        const plantedCountBadge = document.getElementById('planted-count');
        const reminderCountBadge = document.getElementById('reminder-count');

        const notification = document.getElementById('notification');

        // --- State Variables ---
        let trees = JSON.parse(localStorage.getItem('leaflog_trees') || '[]');
        let markers = {};
        let currentBottomSheetView = 'main-menu-view';
        let currentBottomSheetState = 'state-handle';
        let draggedTreeType = null; // Variable to store type during drag

        // --- Bottom Sheet Management (remains the same) ---
        function setBottomSheetState(newState, viewId = null) { bottomSheet.classList.remove('state-handle', 'state-form', 'state-list-partial', 'state-list-full', 'active'); if (newState === 'closed'){ currentBottomSheetState = 'closed'; } else { bottomSheet.classList.add('active', newState); currentBottomSheetState = newState; if (viewId) showBottomSheetView(viewId); } }
        function showBottomSheetView(viewId) { allSheetViews.forEach(v => v.classList.toggle('visible', v.id === viewId)); currentBottomSheetView = viewId; bottomSheet.querySelector('.bottom-sheet-content').scrollTop = 0; }
        setBottomSheetState('state-handle', 'main-menu-view');
        bottomSheet.querySelector('.bottom-sheet-handle').addEventListener('click', () => { if (currentBottomSheetState === 'state-handle') { setBottomSheetState(currentBottomSheetView === 'main-menu-view' ? 'state-list-partial' : 'state-list-full', currentBottomSheetView); } else if (currentBottomSheetState === 'state-list-partial') { setBottomSheetState('state-list-full', currentBottomSheetView); } else { setBottomSheetState('state-handle', 'main-menu-view'); } });
        mainMenuButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('state-list-full', b.dataset.viewTarget)));
        backButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('state-list-partial', 'main-menu-view')));
        closeButtons.forEach(b => b.addEventListener('click', () => setBottomSheetState('closed')));

        // --- FAB Interaction (remains the same) ---
        locateFab.addEventListener('click', () => { if (lastKnownLocation) { map.setView(lastKnownLocation, 16, { animate: true }); if (currentLocationMarker) currentLocationMarker.openPopup(); } else { showNotification("Current location not available."); } });
        addTreeFab.addEventListener('click', (e) => { e.stopPropagation(); addFabContainer.classList.toggle('expanded'); if (addFabContainer.classList.contains('expanded')) { setBottomSheetState('closed'); } });
        document.addEventListener('click', (e) => { if (!addFabContainer.contains(e.target) && addFabContainer.classList.contains('expanded')) { addFabContainer.classList.remove('expanded'); } });


        // --- Drag and Drop Logic ---

        // 1. Listen on draggable elements (sub-FABs)
        subFabs.forEach(fab => {
            fab.addEventListener('dragstart', (e) => {
                draggedTreeType = fab.dataset.treeType; // Store type in our variable
                // e.dataTransfer.setData('text/plain', draggedTreeType); // May still be useful for external drops, but we use our variable primarily
                e.dataTransfer.effectAllowed = 'copy';
                fab.classList.add('dragging');
                console.log(`Drag Start: ${draggedTreeType}`); // Debug log
                // Collapse FABs after a tiny delay to allow drag image capture
                setTimeout(() => {
                     if (addFabContainer.classList.contains('expanded')) {
                         addFabContainer.classList.remove('expanded');
                     }
                }, 0);
                 // Optional: Temporarily disable map dragging
                 // map.dragging.disable();
            });

            fab.addEventListener('dragend', (e) => {
                fab.classList.remove('dragging');
                console.log(`Drag End: ${draggedTreeType}`); // Debug log
                draggedTreeType = null; // Clear the stored type
                // Optional: Re-enable map dragging
                // map.dragging.enable();
            });
        });

        // 2. Listen on the drop target (map container)
        mapContainer.addEventListener('dragenter', (e) => {
            // Optional visual feedback
            // mapContainer.style.border = '2px dashed green'; // Example
             console.log("Drag Enter Map"); // Debug log
        });

         mapContainer.addEventListener('dragleave', (e) => {
            // Optional visual feedback removal
            // mapContainer.style.border = 'none'; // Example
             console.log("Drag Leave Map"); // Debug log
        });

        mapContainer.addEventListener('dragover', (e) => {
            e.preventDefault(); // ** CRUCIAL ** Allow drop
            e.dataTransfer.dropEffect = 'copy';
            // console.log("Dragging Over Map"); // This logs excessively, use if needed
        });

        mapContainer.addEventListener('drop', (e) => {
            e.preventDefault(); // ** CRUCIAL ** Prevent default browser action
             console.log(`Drop Event on Map. Stored type: ${draggedTreeType}`); // Debug log

            // Optional visual feedback removal
            // mapContainer.style.border = 'none'; // Example

            const typeToUse = draggedTreeType; // Get type from our variable
            // const typeFromData = e.dataTransfer.getData('text/plain'); // Fallback or check
             // console.log(`Type from dataTransfer: ${typeFromData}`); // Debug log

            if (typeToUse === 'Spotted' || typeToUse === 'Planted') {
                // Get coordinates from the drop event relative to the map container
                const point = L.point(e.clientX, e.clientY);
                 const latLng = map.containerPointToLatLng(point);
                 console.log("Drop Coords:", latLng); // Debug log

                // Open the form
                openAddForm(latLng.lat, latLng.lng, typeToUse);
            } else {
                console.warn("Invalid data dropped or type not stored correctly.");
            }
             draggedTreeType = null; // Clear stored type after drop attempt
        });


        // --- Form Handling (remains the same) ---
        function openAddForm(lat, lng, treeType) {
             console.log(`Opening form for ${treeType} at ${lat}, ${lng}`); // Debug log
             latInput.value = lat; lngInput.value = lng; typeSelect.value = treeType;
             document.getElementById('species').value = ''; document.getElementById('notes').value = ''; imageInput.value = null; imagePreview.classList.add('hidden');
             setBottomSheetState('state-form', 'add-form-view'); document.getElementById('species').focus();
        }
        cancelFormBtn.addEventListener('click', () => { setBottomSheetState('closed'); treeForm.reset(); imagePreview.classList.add('hidden'); });
        treeForm.addEventListener('submit', (e) => { e.preventDefault(); const lat=parseFloat(latInput.value); const lng=parseFloat(lngInput.value); const type=typeSelect.value; const species=document.getElementById('species').value; const notes=document.getElementById('notes').value; const imageFile=imageInput.files[0]; let imageDataUrl=''; function saveTreeData() { const tree={id:Date.now().toString(),type,species,notes,location:{lat,lng},imageUrl:imageDataUrl,dateAdded:new Date().toISOString(),needsAttention:false}; trees.push(tree); saveTreesToLocalStorage(); addTreeMarker(tree); populateLists(); setBottomSheetState('closed'); treeForm.reset();imagePreview.classList.add('hidden'); showNotification('Tree added successfully!'); } if(imageFile){const reader=new FileReader();reader.onload=(e)=>{imageDataUrl=e.target.result;saveTreeData();};reader.readAsDataURL(imageFile);}else{saveTreeData();} });

        // --- Image Preview, Local Storage, Markers, Popups, Reminders (remain same) ---
        imageInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (e) => { previewImg.src = e.target.result; imagePreview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { imagePreview.classList.add('hidden'); } });
        function saveTreesToLocalStorage() { localStorage.setItem('leaflog_trees', JSON.stringify(trees)); }
        function addTreeMarker(tree) { const marker = L.marker([tree.location.lat, tree.location.lng]).addTo(map); markers[tree.id] = marker; marker.bindPopup(() => createPopupContent(tree)); marker.on('popupopen', () => attachReminderButtonListener(tree.id)); }
        function createPopupContent(tree) { /* ... */ const rbt=tree.needsAttention?'Remove Reminder':'Add Reminder'; const rbc=tree.needsAttention?'bg-yellow-500 hover:bg-yellow-600':'bg-blue-500 hover:bg-blue-600'; let c=`<div class="popup-content"><h3 class="text-lg font-semibold">${tree.species}</h3><p class="text-sm text-gray-600"><strong>Type:</strong> ${tree.type}</p>`; if(tree.notes)c+=`<p class="text-sm mt-1"><strong>Notes:</strong> ${tree.notes}</p>`; if(tree.imageUrl)c+=`<img src="${tree.imageUrl}" alt="${tree.species}" class="popup-image mt-2">`; c+=`<button class="toggle-reminder-btn text-xs text-white px-2 py-1 rounded mt-3 ${rbc}" data-tree-id="${tree.id}"><i class="fas ${tree.needsAttention?'fa-bell-slash':'fa-bell'} mr-1"></i>${rbt}</button></div>`; return c; }
        function attachReminderButtonListener(treeId) { /* ... */ const b=document.querySelector(`.toggle-reminder-btn[data-tree-id="${treeId}"]`); if(b){b.removeEventListener('click',handleReminderToggle); b.addEventListener('click',handleReminderToggle);} }
        function handleReminderToggle(event) { /* ... */ const b=event.target.closest('button'); const tId=b.getAttribute('data-tree-id'); const tIdx=trees.findIndex(t=>t.id===tId); if(tIdx!==-1){trees[tIdx].needsAttention=!trees[tIdx].needsAttention; saveTreesToLocalStorage(); const m=markers[tId]; if(m&&m.isPopupOpen()){m.setPopupContent(createPopupContent(trees[tIdx])); attachReminderButtonListener(tId);} populateLists(); showNotification(trees[tIdx].needsAttention?'Reminder added!':'Reminder removed.');} }

        // --- List Population (remains same) ---
        function populateLists() { /* ... same logic ... */ spottedList.innerHTML=''; plantedList.innerHTML=''; remindersList.innerHTML=''; let sc=0, pc=0, rc=0; const sorted=[...trees].sort((a,b)=>a.species.localeCompare(b.species)); sorted.forEach(tree=>{const itemHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-tree mr-2 ${tree.type==='Planted'?'text-blue-600':'text-green-600'}"></i><span class="font-medium">${tree.species}</span>${tree.notes?`<span class="text-xs text-gray-500 block ml-5 truncate" title="${tree.notes}">(${tree.notes.substring(0,30)}${tree.notes.length>30?'...':''})</span>`:''}</span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`;const action=()=>{const targetTree=trees.find(t=>t.id===tree.id); if(targetTree){setBottomSheetState('closed'); map.setView(targetTree.location, 17, {animate:true}); setTimeout(()=>{if(markers[targetTree.id]) markers[targetTree.id].openPopup();}, 300); }}; const listItem=document.createElement('li');listItem.className='list-item';listItem.innerHTML=itemHTML; listItem.querySelector('.view-on-map-btn').addEventListener('click',action); if(tree.type==='Spotted'){spottedList.appendChild(listItem); sc++;} else if(tree.type==='Planted'){plantedList.appendChild(listItem); pc++;} if(tree.needsAttention){const reminderItem=document.createElement('li');reminderItem.className='list-item';reminderItem.innerHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-bell mr-2 text-orange-500"></i><span class="font-medium">${tree.species}</span> <span class="text-xs text-gray-500">(${tree.type})</span></span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`;reminderItem.querySelector('.view-on-map-btn').addEventListener('click',action);remindersList.appendChild(reminderItem);rc++;}}); spottedCountBadge.textContent=sc; plantedCountBadge.textContent=pc; reminderCountBadge.textContent=rc; const placeholderHTML='<li class="text-gray-500 italic p-4 text-center">Nothing here yet.</li>'; if(sc===0)spottedList.innerHTML=placeholderHTML; if(pc===0)plantedList.innerHTML=placeholderHTML; if(rc===0)remindersList.innerHTML=placeholderHTML; }

        // --- Notification (same) ---
        function showNotification(message) { document.getElementById('notification-text').textContent=message; notification.classList.remove('translate-x-full'); notification.classList.add('translate-x-0'); setTimeout(()=>{notification.classList.remove('translate-x-0'); notification.classList.add('translate-x-full');},3000); }

        // --- Initialization (same) ---
        function initializeApp() { loadExistingTrees(); populateLists(); setBottomSheetState('state-handle', 'main-menu-view'); }
        function loadExistingTrees() { trees.forEach(tree => { if (tree.needsAttention === undefined) tree.needsAttention = false; addTreeMarker(tree); }); }
        initializeApp();

    </script>
</body>
</html>