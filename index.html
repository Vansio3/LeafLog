<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LeafLog - Tree Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <style>
        /* Base styles */
        body, html {
            height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* Disable Text Selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: 10; height: 50px; }

        /* Disable Focus Outline/Highlight Globally */
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        button:focus, select:focus, input:focus, textarea:focus {
             outline: none !important;
             box-shadow: none !important;
             /* Override potential Tailwind focus rings */
             --tw-ring-offset-shadow: none !important;
             --tw-ring-shadow: none !important;
             box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow, 0 0 #0000) !important;
        }

        /* Disable Tap Highlight */
        button, a, input, select, textarea, .fab, .sub-fab, .sidebar-category-trigger, .view-on-map-btn, .leaflet-popup-content button {
            -webkit-tap-highlight-color: transparent;
             tap-highlight-color: transparent; /* Future-proofing */
        }


        /* --- Sidebar Menu --- */
        #sidebar-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 300px; /* Adjust width as needed */
            max-width: 85%; /* Max width on smaller screens */
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
            z-index: 1002; /* Above FABs, potentially below form sheet if needed */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll, manage scroll internally */
        }
        #sidebar-menu.open {
            transform: translateX(0);
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background-color: #f9fafb; /* Light bg for header */
            flex-shrink: 0; /* Prevent header from shrinking */
        }
         .sidebar-header h2 {
             font-size: 1.1rem;
             font-weight: 600;
             color: #333;
             margin: 0;
         }
         #sidebar-close-btn {
             background: none; border: none; font-size: 1.4rem; color: #6b7280; cursor: pointer; padding: 5px;
         }
         /* Remove hover effects */
         #sidebar-close-btn:hover { color: #6b7280; }

        .sidebar-content-wrapper { /* Container for views */
            overflow-y: auto; /* Allow this part to scroll */
            flex-grow: 1;
        }
        .sidebar-view {
            display: none; /* Hide views by default */
        }
        .sidebar-view.visible {
            display: block; /* Show active view */
        }
         /* Main menu view specifics */
         #sidebar-main-view { padding: 1rem; } /* Add padding to main view */
         .sidebar-section { margin-bottom: 0.5rem; }
         .sidebar-category-trigger {
             display: flex; justify-content: space-between; align-items: center; width: 100%;
             padding: 12px 10px; text-align: left; font-size: 1rem;
             border: 1px solid #e5e7eb; border-radius: 6px; background-color: white;
             cursor: pointer; transition: background-color 0.2s;
         }
         /* Remove hover effect */
         .sidebar-category-trigger:hover { background-color: white; }
         .sidebar-category-trigger span:first-child { font-weight: 500; color: #374151; display: flex; align-items: center; }
         .sidebar-category-trigger .count-badge { background-color: #e0e0e0; color: #555; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.8em; font-weight: bold; }

        /* List view specifics */
         .sidebar-list-header {
             display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; background-color: #f9fafb; position: sticky; top: 0; /* Make header sticky within scrollable area */ z-index: 1; /* Ensure it stays above list items */
         }
         .sidebar-list-header h3 { font-size: 1rem; font-weight: 600; color: #333; margin: 0; flex-grow: 1; text-align: center; }
         .sidebar-back-btn { background: none; border: none; font-size: 1.2rem; color: #4b5563; cursor: pointer; padding: 5px; min-width: 30px; text-align: left;}
         .sidebar-list-header span { min-width: 30px; } /* Spacer for centering title */
         /* Remove hover effects */
         .sidebar-back-btn:hover { color: #4b5563; }

        .sidebar-list { list-style: none; padding: 0; margin: 0; }
         #sidebar-spotted-view .sidebar-list,
         #sidebar-planted-view .sidebar-list,
         #sidebar-reminders-view .sidebar-list {
             padding: 0.5rem 1rem 1rem 1rem;
         }


        /* FAB General Styles */
        .fab { background-color: #16a34a; color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s ease; border: none; }
        /* Remove hover/active effects */
        .fab:hover { background-color: #16a34a; } /* Keep original bg */
        .fab:active {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Restore original shadow */
            transform: none; /* Remove translateY */
        }
        .fab i { font-size: 24px; transition: transform 0.3s ease; }

        /* Locate FAB Container */
        .locate-fab-container { position: fixed; bottom: 20px; right: 15px; z-index: 1000; }
        .fab-secondary { background-color: #ffffff; color: #374151; width: 48px; height: 48px; }
        /* Remove hover effect */
        .fab-secondary:hover { background-color: #ffffff; } /* Keep original bg */
        .fab-secondary i { font-size: 20px; }

        /* Add FAB Container & Expansion */
        #add-fab-container { position: fixed; bottom: 80px; right: 15px; z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        #add-tree-fab { position: relative; z-index: 1001; }
        #add-fab-container.expanded #add-tree-fab i { transform: rotate(45deg); }

        /* Sub FABs (Spotted/Planted) */
        .sub-fab { width: 45px; height: 45px; font-size: 0.8em; font-weight: 600; position: absolute; bottom: 5px; right: 5px; z-index: 1000; opacity: 0; transform: scale(0.5) translateY(10px); transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0s linear; /* Add visibility transition */ cursor: grab; /* Change cursor */ pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; text-align: center; line-height: 1.1; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .sub-fab:active { cursor: grabbing; } /* Change cursor while dragging */
        #add-fab-container.expanded .sub-fab { position: relative; bottom: auto; right: auto; opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        #sub-fab-spotted { background-color: #fbbf24; color: #422006; }
        #sub-fab-planted { background-color: #3b82f6; color: white; }
        /* Remove hover effects */
        #sub-fab-spotted:hover { background-color: #fbbf24; }
        #sub-fab-planted:hover { background-color: #3b82f6; }

        /* Drag Simulation Styles */
        #drag-clone { position: fixed; z-index: 1010; pointer-events: none; opacity: 0.75; width: 45px; height: 45px; font-size: 0.8em; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; text-align: center; line-height: 1.1; border-radius: 50%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); cursor: grabbing; } /* Ensure clone has grabbing cursor */
        body.dragging-active { cursor: grabbing !important; user-select: none; }
        #map.drag-over { outline: 2px dashed #16a34a; outline-offset: -2px; }

        /* Bottom Sheet (FOR FORM ONLY) */
        #bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15); z-index: 1003; /* Higher z-index than sidebar */ transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); max-height: 90vh; display: flex; flex-direction: column; }
        #bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet-content { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .bottom-sheet-view { display: none; } .bottom-sheet-view.visible { display: block; } /* Only add-form-view will use this */
        .bottom-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
        .bottom-sheet-header h3 { font-size: 1.2rem; font-weight: 600; color: #333; margin: 0; flex-grow: 1; text-align: center; }
        .bottom-sheet-header span { min-width: 30px; }
        .bottom-sheet-close-btn { background: none; border: none; font-size: 1.3rem; color: #6b7280; cursor: pointer; padding: 5px; min-width: 30px; text-align: right; }
        /* Remove hover effects */
        .bottom-sheet-close-btn:hover { color: #6b7280; }
        #add-form-view { padding-top: 0; } #add-form-view form { margin-top: 0; }

        /* List Item Styles (used in sidebar) */
        .list-item { padding: 10px 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .list-item .view-on-map-btn { background: none; border: none; color: #3498db; cursor: pointer; font-size: 0.9em; margin-left: 8px; padding: 0.25rem; white-space: nowrap; }
        /* Remove hover effects */
        .list-item .view-on-map-btn:hover { text-decoration: none; color: #3498db; }

        /* Popup Styles */
        .popup-image { max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px; margin-top: 8px; }
        .leaflet-popup-content { min-width: 220px; padding-bottom: 8px !important; }
        /* Remove hover effects for popup buttons */
        .popup-edit-btn:hover { color: #3b82f6 !important; text-decoration: none !important; } /* Tailwind blue-600 */
        .popup-delete-btn:hover { color: #dc2626 !important; text-decoration: none !important; } /* Tailwind red-600 */
        .toggle-reminder-btn { transition: background-color 0.2s; }
        /* Remove hover effects for reminder toggle, adjust classes */
        .toggle-reminder-btn[data-tree-id]:hover {
            /* Keep original color based on state */
        }
        .toggle-reminder-btn.bg-yellow-500:hover { background-color: #f59e0b !important; } /* Keep original yellow hover if desired, or set to bg-yellow-500 */
        .toggle-reminder-btn.bg-blue-500:hover { background-color: #3b82f6 !important; } /* Keep original blue hover if desired, or set to bg-blue-500 */

        /* Override specific hover classes used in createPopupContent if necessary */
        .bg-yellow-500.hover\:bg-yellow-600:hover { background-color: #f59e0b !important; } /* or #facc15 if no change */
        .bg-blue-500.hover\:bg-blue-600:hover { background-color: #3b82f6 !important; } /* or #3b82f6 */
        .text-blue-600.hover\:text-blue-800:hover { color: #3b82f6 !important; } /* or #3b82f6 */
        .text-red-600.hover\:text-red-800:hover { color: #dc2626 !important; } /* or #dc2626 */

        /* Current Location Icon */
        .current-location-div-icon { background: none; border: none; }

        /* Print Styles */
        @media print { body, html { height: auto; overflow: visible; user-select: auto; /* Allow selection for print */ } #map { height: 95vh !important; page-break-inside: avoid; width: 100% !important; } .no-print { display: none !important; } .header { position: relative !important; } #bottom-sheet, .locate-fab-container, #add-fab-container, #sidebar-menu { display: none !important; } .current-location-div-icon { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-green-700 text-white p-3 shadow-md header no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold"><i class="fas fa-leaf mr-1"></i>LeafLog</h1>
            <!-- Removed hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-white -->
            <button id="header-menu-btn" class="text-white p-2 rounded" aria-label="Open menu">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Sidebar Menu -->
     <div id="sidebar-menu" class="no-print">
         <div class="sidebar-header">
             <h2 id="sidebar-title">Menu</h2> <!-- Title managed by JS -->
             <button id="sidebar-close-btn" aria-label="Close menu">
                 <i class="fas fa-times"></i>
             </button>
         </div>
         <!-- Container for switching views -->
         <div class="sidebar-content-wrapper flex-grow overflow-y-auto">

             <!-- Main Menu View (Visible Initially) -->
             <div id="sidebar-main-view" class="sidebar-view visible p-4">
                 <div class="sidebar-section">
                     <button class="sidebar-category-trigger" data-target-view="sidebar-spotted-view">
                         <span><i class="fas fa-binoculars mr-2 text-yellow-500"></i>Spotted Trees</span>
                         <span id="sidebar-spotted-count" class="count-badge">0</span>
                     </button>
                 </div>
                 <div class="sidebar-section">
                     <button class="sidebar-category-trigger" data-target-view="sidebar-planted-view">
                         <span><i class="fas fa-seedling mr-2 text-blue-500"></i>Planted Trees</span>
                         <span id="sidebar-planted-count" class="count-badge">0</span>
                     </button>
                 </div>
                 <div class="sidebar-section">
                      <button class="sidebar-category-trigger" data-target-view="sidebar-reminders-view">
                         <span><i class="fas fa-bell mr-2 text-orange-500"></i>Reminders</span>
                         <span id="sidebar-reminder-count" class="count-badge">0</span>
                     </button>
                 </div>
             </div>

             <!-- Spotted List View (Hidden Initially) -->
             <div id="sidebar-spotted-view" class="sidebar-view hidden">
                 <div class="sidebar-list-header">
                     <button class="sidebar-back-btn" aria-label="Back to main menu"><i class="fas fa-arrow-left"></i></button>
                     <h3>Spotted Trees</h3>
                     <span></span> <!-- Spacer -->
                 </div>
                 <ul id="sidebar-spotted-list" class="sidebar-list p-4">
                     <li class="text-gray-500 italic p-2">Loading...</li>
                 </ul>
             </div>

             <!-- Planted List View (Hidden Initially) -->
             <div id="sidebar-planted-view" class="sidebar-view hidden">
                  <div class="sidebar-list-header">
                     <button class="sidebar-back-btn" aria-label="Back to main menu"><i class="fas fa-arrow-left"></i></button>
                     <h3>Planted Trees</h3>
                     <span></span> <!-- Spacer -->
                 </div>
                 <ul id="sidebar-planted-list" class="sidebar-list p-4">
                     <li class="text-gray-500 italic p-2">Loading...</li>
                 </ul>
             </div>

             <!-- Reminders List View (Hidden Initially) -->
             <div id="sidebar-reminders-view" class="sidebar-view hidden">
                  <div class="sidebar-list-header">
                     <button class="sidebar-back-btn" aria-label="Back to main menu"><i class="fas fa-arrow-left"></i></button>
                     <h3>Reminders</h3>
                     <span></span> <!-- Spacer -->
                 </div>
                 <ul id="sidebar-reminders-list" class="sidebar-list p-4">
                     <li class="text-gray-500 italic p-2">Loading...</li>
                 </ul>
             </div>

         </div> <!-- End sidebar-content-wrapper -->
     </div>


    <!-- Map -->
    <div id="map"></div>

    <!-- Locate FAB -->
    <div class="locate-fab-container no-print">
         <button id="locate-fab" class="fab fab-secondary" aria-label="Center on my location">
             <i class="fas fa-location-arrow"></i>
         </button>
    </div>

    <!-- Add FAB Container -->
    <div id="add-fab-container" class="no-print">
         <button id="sub-fab-spotted" class="fab sub-fab" data-tree-type="Spotted"> <i class="fas fa-binoculars"></i>Spot </button>
         <button id="sub-fab-planted" class="fab sub-fab" data-tree-type="Planted"> <i class="fas fa-seedling"></i>Plant </button>
         <button id="add-tree-fab" class="fab" aria-label="Add new tree"> <i class="fas fa-plus"></i> </button>
    </div>

    <!-- Bottom Sheet (FOR FORM ONLY) -->
    <div id="bottom-sheet" class="no-print">
         <div class="bottom-sheet-content">
            <!-- Add/Edit Form View -->
            <div id="add-form-view" class="bottom-sheet-view visible"> <!-- Make visible by default -->
                 <div class="bottom-sheet-header">
                   <span></span> <!-- Spacer -->
                   <h3 id="form-title"></h3> <!-- Give title an ID -->
                   <button class="bottom-sheet-close-btn" aria-label="Cancel add/edit tree"><i class="fas fa-times"></i></button>
                 </div>
                 <form id="tree-form" class="space-y-4">
                    <input type="hidden" id="edit-tree-id" name="editTreeId">
                    <input type="hidden" id="lat" name="lat">
                    <input type="hidden" id="lng" name="lng">
                    <div>
                       <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                       <!-- Removed focus:outline-none focus:ring-green-500 focus:border-green-500 -->
                       <select id="type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" disabled>
                           <option value="Spotted">Spotted</option>
                           <option value="Planted">Planted</option>
                       </select>
                    </div>
                    <div>
                       <label for="species" class="block text-sm font-medium text-gray-700 mb-1">Species *</label>
                       <!-- Removed focus:outline-none focus:ring-green-500 focus:border-green-500 -->
                       <input type="text" id="species" name="species" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Oak, Maple">
                    </div>
                    <div>
                       <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                       <!-- Removed focus:outline-none focus:ring-green-500 focus:border-green-500 -->
                       <textarea id="notes" name="notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Observations..."></textarea>
                    </div>
                    <div>
                       <label for="image" class="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                       <!-- Removed focus:outline-none focus:ring-green-500 focus:border-green-500 -->
                       <input type="file" id="image" name="image" accept="image/*" class="w-full px-3 py-1 text-sm border border-gray-300 rounded-md shadow-sm">
                       <div id="image-preview" class="mt-2 hidden">
                           <img id="preview-img" src="#" alt="Preview" class="h-32 object-cover rounded-md">
                       </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                       <!-- Removed hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 -->
                       <button type="button" id="cancel-form-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md">Cancel</button>
                       <!-- Removed hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 -->
                       <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md">Save Tree</button>
                    </div>
                 </form>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-16 right-4 bg-green-500 text-white p-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full no-print" style="z-index: 1002;">
        <p id="notification-text" class="text-sm"></p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- Map Initialization & Geolocation ---
            const defaultCoords = [42.501511, 27.466138];
            const map = L.map('map', { zoomControl: false }).setView(defaultCoords, 13);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM', maxZoom: 19 }).addTo(map);
            const currentLocationIcon = L.divIcon({ html: '<i class="fas fa-location-arrow text-blue-600 text-2xl"></i>', className: 'current-location-div-icon', iconSize: [24, 24], iconAnchor: [12, 12] });
            let currentLocationMarker = null; let lastKnownLocation = null;
            if (navigator.geolocation) { navigator.geolocation.watchPosition( (pos) => { const lat=pos.coords.latitude, lng=pos.coords.longitude; lastKnownLocation=[lat,lng]; if(!currentLocationMarker){ currentLocationMarker=L.marker(lastKnownLocation, {icon: currentLocationIcon}).addTo(map); } else { currentLocationMarker.setLatLng(lastKnownLocation); } }, (err) => { console.error("Geo Err: ", err.message); if(currentLocationMarker){map.removeLayer(currentLocationMarker); currentLocationMarker=null;} lastKnownLocation=null; showNotification(`Location error: ${err.message}`); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); } else { console.log("Geo not supported."); }

            // --- DOM References ---
            // Sidebar Menu
            const sidebarMenu = document.getElementById('sidebar-menu');
            const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
            const headerMenuBtn = document.getElementById('header-menu-btn');
            const sidebarContentWrapper = sidebarMenu.querySelector('.sidebar-content-wrapper');
            const sidebarViews = sidebarContentWrapper.querySelectorAll('.sidebar-view');
            const sidebarMainView = document.getElementById('sidebar-main-view');
            const categoryTriggers = sidebarMainView.querySelectorAll('.sidebar-category-trigger');
            const sidebarBackBtns = sidebarMenu.querySelectorAll('.sidebar-back-btn');
            const sidebarSpottedList = document.getElementById('sidebar-spotted-list');
            const sidebarPlantedList = document.getElementById('sidebar-planted-list');
            const sidebarRemindersList = document.getElementById('sidebar-reminders-list');
            const sidebarSpottedCount = document.getElementById('sidebar-spotted-count');
            const sidebarPlantedCount = document.getElementById('sidebar-planted-count');
            const sidebarReminderCount = document.getElementById('sidebar-reminder-count');
            const sidebarTitle = document.getElementById('sidebar-title');
            // Bottom Sheet (Form only)
            const bottomSheet = document.getElementById('bottom-sheet');
            const addFormView = document.getElementById('add-form-view');
            const bottomSheetCloseBtn = bottomSheet.querySelector('.bottom-sheet-close-btn');
            const treeForm = document.getElementById('tree-form');
            const latInput = document.getElementById('lat');
            const lngInput = document.getElementById('lng');
            const typeSelect = document.getElementById('type');
            const speciesInput = document.getElementById('species');
            const notesInput = document.getElementById('notes');
            const imageInput = document.getElementById('image');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const cancelFormBtn = document.getElementById('cancel-form-btn');
            const editTreeIdInput = document.getElementById('edit-tree-id');
            const addFormTitle = document.getElementById('form-title'); // Use ID for form title
            // FABs
            const locateFab = document.getElementById('locate-fab');
            const addFabContainer = document.getElementById('add-fab-container');
            const addTreeFab = document.getElementById('add-tree-fab');
            const subFabs = addFabContainer.querySelectorAll('.sub-fab');
            // Other
            const mapContainer = document.getElementById('map');
            const notification = document.getElementById('notification');

            // --- State Variables ---
            let trees = JSON.parse(localStorage.getItem('leaflog_trees') || '[]');
            let markers = {};
            let currentSidebarView = 'sidebar-main-view'; // Track sidebar view
            let isDragging = false; let dragClone = null; let dragTreeType = null; let startX, startY, offsetX, offsetY;
            let hasDragged = false; // Flag to check if actual dragging occurred
            let draggedOriginalFab = null; // Reference to the original FAB being dragged

            // --- Function Definitions ---

            // Sidebar Menu Management
            function openSidebarMenu() {
                 if (sidebarMenu) {
                    showSidebarView('sidebar-main-view'); // Always show main view first
                    sidebarMenu.classList.add('open');
                 }
            }
            function closeSidebarMenu() {
                 if (sidebarMenu) {
                     sidebarMenu.classList.remove('open');
                 }
            }
             function showSidebarView(viewId) {
                 sidebarViews.forEach(view => {
                     view.classList.toggle('hidden', view.id !== viewId);
                     view.classList.toggle('visible', view.id === viewId);
                 });
                 const targetViewElement = document.getElementById(viewId);
                 const titleElement = targetViewElement?.querySelector('h3');
                 sidebarTitle.textContent = viewId === 'sidebar-main-view' ? 'Menu' : (titleElement?.textContent || 'Menu');
                 currentSidebarView = viewId;
                 if (sidebarContentWrapper) sidebarContentWrapper.scrollTop = 0;
             }

             // Bottom Sheet (Form) Management
             function openFormSheet() { if (bottomSheet) bottomSheet.classList.add('active'); }
             function closeFormSheet() { if (bottomSheet) bottomSheet.classList.remove('active'); editTreeIdInput.value = ''; treeForm.reset(); imagePreview.classList.add('hidden'); previewImg.src = '#'; /* Clear preview */ }

            // Form Handling
            function openAddForm(lat, lng, treeType) { editTreeIdInput.value = ''; addFormTitle.textContent = 'Add New Tree'; latInput.value = lat; lngInput.value = lng; typeSelect.value = treeType; speciesInput.value = ''; notesInput.value = ''; imageInput.value = null; /* Clear file input */ imagePreview.classList.add('hidden'); previewImg.src = '#'; /* Clear preview */ openFormSheet(); speciesInput.focus(); }
            function openEditForm(treeId) { const tree = trees.find(t => t.id === treeId); if (!tree) { console.error("Tree not found for editing:", treeId); return; } map.closePopup(); editTreeIdInput.value = treeId; addFormTitle.textContent = 'Edit Tree'; latInput.value = tree.location.lat; lngInput.value = tree.location.lng; typeSelect.value = tree.type; speciesInput.value = tree.species; notesInput.value = tree.notes || ''; imageInput.value = null; /* Clear file input */ if (tree.imageUrl) { previewImg.src = tree.imageUrl; imagePreview.classList.remove('hidden'); } else { imagePreview.classList.add('hidden'); previewImg.src = '#'; /* Clear preview */ } openFormSheet(); speciesInput.focus(); }

            // Local Storage & Marker Management
            function saveTreesToLocalStorage() { localStorage.setItem('leaflog_trees', JSON.stringify(trees)); }
            function addTreeMarker(tree) { const marker = L.marker([tree.location.lat, tree.location.lng]).addTo(map); markers[tree.id] = marker; marker.on('popupopen', () => attachPopupListeners(tree.id)); marker.bindPopup(() => createPopupContent(tree)); }
            function createPopupContent(tree) { const reminderButtonText = tree.needsAttention ? 'Remove Reminder' : 'Add Reminder'; const reminderButtonClass = tree.needsAttention ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600'; let c = `<div class="popup-content"><h3 class="text-lg font-semibold">${tree.species}</h3><p class="text-sm text-gray-600"><strong>Type:</strong> ${tree.type}</p>`; if (tree.notes) c += `<p class="text-sm mt-1"><strong>Notes:</strong> ${tree.notes}</p>`; if (tree.imageUrl) c += `<img src="${tree.imageUrl}" alt="${tree.species}" class="popup-image mt-2">`; c += `<button class="toggle-reminder-btn text-xs text-white px-2 py-1 rounded mt-3 ${reminderButtonClass}" data-tree-id="${tree.id}"><i class="fas ${tree.needsAttention ? 'fa-bell-slash' : 'fa-bell'} mr-1"></i>${reminderButtonText}</button>`; c += `<div class="mt-3 pt-2 border-t border-gray-200 flex justify-end space-x-2"><button class="popup-edit-btn text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded" data-tree-id="${tree.id}" aria-label="Edit tree"><i class="fas fa-edit mr-1"></i>Edit</button><button class="popup-delete-btn text-xs text-red-600 hover:text-red-800 px-2 py-1 rounded" data-tree-id="${tree.id}" aria-label="Delete tree"><i class="fas fa-trash-alt mr-1"></i>Delete</button></div>`; c += `</div>`; return c; }
            function attachPopupListeners(treeId) { const popupNode = document.querySelector(`.leaflet-popup-content`); if (!popupNode) { console.error("Cannot find popup content node."); return; } const reminderBtn = popupNode.querySelector(`.toggle-reminder-btn[data-tree-id="${treeId}"]`); if (reminderBtn) { reminderBtn.replaceWith(reminderBtn.cloneNode(true)); popupNode.querySelector(`.toggle-reminder-btn[data-tree-id="${treeId}"]`).addEventListener('click', handleReminderToggle); } const editBtn = popupNode.querySelector(`.popup-edit-btn[data-tree-id="${treeId}"]`); if (editBtn) { editBtn.replaceWith(editBtn.cloneNode(true)); popupNode.querySelector(`.popup-edit-btn[data-tree-id="${treeId}"]`).addEventListener('click', handleEditTree); } const deleteBtn = popupNode.querySelector(`.popup-delete-btn[data-tree-id="${treeId}"]`); if (deleteBtn) { deleteBtn.replaceWith(deleteBtn.cloneNode(true)); popupNode.querySelector(`.popup-delete-btn[data-tree-id="${treeId}"]`).addEventListener('click', handleDeleteTree); } }
            function handleReminderToggle(event) { const b=event.target.closest('button'); const tId=b.getAttribute('data-tree-id'); const tIdx=trees.findIndex(t=>t.id===tId); if(tIdx!==-1){trees[tIdx].needsAttention=!trees[tIdx].needsAttention; saveTreesToLocalStorage(); const m=markers[tId]; if(m&&m.isPopupOpen()){m.setPopupContent(createPopupContent(trees[tIdx])); attachPopupListeners(tId); } populateSidebarMenu(); showNotification(trees[tIdx].needsAttention?'Reminder added!':'Reminder removed.');} }
            function handleEditTree(event) { const button = event.target.closest('button'); const treeId = button.dataset.treeId; openEditForm(treeId); }
            function handleDeleteTree(event) { const button = event.target.closest('button'); const treeId = button.dataset.treeId; const treeIndex = trees.findIndex(t => t.id === treeId); if (treeIndex === -1) return; const treeSpecies = trees[treeIndex].species; if (!window.confirm(`Delete ${treeSpecies}?`)) return; map.closePopup(); const marker = markers[treeId]; if (marker) { map.removeLayer(marker); delete markers[treeId]; } trees.splice(treeIndex, 1); try { saveTreesToLocalStorage(); } catch (error) { showNotification("Error saving deletion."); } populateSidebarMenu(); showNotification(`"${treeSpecies}" deleted.`); }

            // Sidebar Menu List Population
            function populateSidebarMenu() {
                if (!sidebarSpottedList || !sidebarPlantedList || !sidebarRemindersList || !sidebarSpottedCount || !sidebarPlantedCount || !sidebarReminderCount) { console.error("Sidebar list/count elements missing."); return; }
                sidebarSpottedList.innerHTML = ''; sidebarPlantedList.innerHTML = ''; sidebarRemindersList.innerHTML = '';
                let sc=0, pc=0, rc=0;
                const sorted=[...trees].sort((a,b)=>a.species.localeCompare(b.species));

                sorted.forEach(tree=>{
                     const itemHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-tree mr-2 ${tree.type==='Planted'?'text-blue-600':'text-green-600'}"></i><span class="font-medium">${tree.species}</span>${tree.notes?`<span class="text-xs text-gray-500 block ml-5 truncate" title="${tree.notes}">(${tree.notes.substring(0,30)}${tree.notes.length>30?'...':''})</span>`:''}</span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`;
                     const action=()=>{ const targetTree=trees.find(t=>t.id===tree.id); if(targetTree){ closeSidebarMenu(); map.setView(targetTree.location, 17, {animate:true}); setTimeout(()=>{if(markers[targetTree.id]) markers[targetTree.id].openPopup();}, 300); }};
                     const listItem=document.createElement('li'); listItem.className='list-item'; listItem.innerHTML=itemHTML; listItem.querySelector('.view-on-map-btn').addEventListener('click',action);

                    let targetList;
                    if(tree.type==='Spotted'){ targetList = sidebarSpottedList; sc++; }
                    else if(tree.type==='Planted'){ targetList = sidebarPlantedList; pc++; }
                    if(targetList) targetList.appendChild(listItem);

                    if(tree.needsAttention){
                        const reminderItem=document.createElement('li'); reminderItem.className='list-item'; reminderItem.innerHTML=`<span class="flex-grow mr-2 overflow-hidden"><i class="fas fa-bell mr-2 text-orange-500"></i><span class="font-medium">${tree.species}</span> <span class="text-xs text-gray-500">(${tree.type})</span></span><button class="view-on-map-btn" data-tree-id="${tree.id}"><i class="fas fa-map-marker-alt mr-1"></i>View</button>`; reminderItem.querySelector('.view-on-map-btn').addEventListener('click',action);
                        sidebarRemindersList.appendChild(reminderItem); rc++;
                    }
                });
                sidebarSpottedCount.textContent=sc; sidebarPlantedCount.textContent=pc; sidebarReminderCount.textContent=rc;
                const placeholderHTML='<li class="text-gray-500 italic p-4 text-center">Nothing here yet.</li>';
                if(sc===0) sidebarSpottedList.innerHTML=placeholderHTML;
                if(pc===0) sidebarPlantedList.innerHTML=placeholderHTML;
                if(rc===0) sidebarRemindersList.innerHTML=placeholderHTML;
            }

            // Notification
            function showNotification(message) { document.getElementById('notification-text').textContent=message; notification.classList.remove('translate-x-full'); notification.classList.add('translate-x-0'); setTimeout(()=>{notification.classList.remove('translate-x-0'); notification.classList.add('translate-x-full');},3000); }
            // Load existing data
            function loadExistingTrees() { trees.forEach(tree => { if (tree.needsAttention === undefined) tree.needsAttention = false; addTreeMarker(tree); }); }

            // Drag Simulation Functions
            function startDrag(e) {
                if (e.type === 'touchstart') e.preventDefault();
                const fab = e.currentTarget; // This IS the original FAB
                dragTreeType = fab.dataset.treeType;
                isDragging = true;
                hasDragged = false;
                draggedOriginalFab = fab; // Store the reference

                const touch = e.type === 'touchstart' ? e.touches[0] : e;
                startX = touch.clientX;
                startY = touch.clientY;
                const rect = fab.getBoundingClientRect();
                offsetX = startX - rect.left;
                offsetY = startY - rect.top;

                dragClone = fab.cloneNode(true);
                dragClone.id = 'drag-clone';
                dragClone.style.left = `${startX - offsetX}px`;
                dragClone.style.top = `${startY - offsetY}px`;
                dragClone.style.backgroundColor = window.getComputedStyle(fab).backgroundColor;
                dragClone.style.color = window.getComputedStyle(fab).color;
                document.body.appendChild(dragClone);
                document.body.classList.add('dragging-active');

                // Hide the original FAB
                if (draggedOriginalFab) {
                    draggedOriginalFab.style.visibility = 'hidden';
                }

                map.dragging.disable();
                if (map.doubleClickZoom) map.doubleClickZoom.disable();
            }

            function dragMove(e) {
                if (!isDragging || !dragClone) return;
                if (e.type === 'touchmove') e.preventDefault();
                const touch = e.type === 'touchmove' ? e.touches[0] : e;
                const currentX = touch.clientX;
                const currentY = touch.clientY;

                // Check if movement threshold is exceeded
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                if (!hasDragged && (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10)) {
                    hasDragged = true; // Set the flag if moved enough
                }

                dragClone.style.left = `${currentX - offsetX}px`;
                dragClone.style.top = `${currentY - offsetY}px`;

                const elementUnderPointer = document.elementFromPoint(currentX, currentY);
                mapContainer.classList.toggle('drag-over', mapContainer.contains(elementUnderPointer));
            }

            function endDrag(e) {
                // Restore visibility of the original FAB FIRST
                if (draggedOriginalFab) {
                    draggedOriginalFab.style.visibility = 'visible';
                }

                // Now proceed with the rest of the endDrag logic
                if (!isDragging) return; // Exit if not dragging

                map.dragging.enable();
                if (map.doubleClickZoom) map.doubleClickZoom.enable();
                if (dragClone) {
                    dragClone.remove();
                    dragClone = null;
                }
                document.body.classList.remove('dragging-active');
                mapContainer.classList.remove('drag-over');

                const touch = e.type === 'touchend' ? e.changedTouches[0] : e;
                const finalX = touch.clientX;
                const finalY = touch.clientY;
                const elementUnderPointer = document.elementFromPoint(finalX, finalY);

                let addedTree = false; // Flag to track success

                // Check hasDragged flag here
                if (mapContainer.contains(elementUnderPointer) && hasDragged) {
                    const point = map.containerPointToLayerPoint([finalX, finalY]);
                    const latLng = map.layerPointToLatLng(point);
                    console.log("Drop Coords (Dragged):", latLng);
                    if (latLng && dragTreeType) {
                        openAddForm(latLng.lat, latLng.lng, dragTreeType);
                        addedTree = true; // Set flag on success
                    } else {
                        console.warn("Could not get LatLng or tree type on drop.");
                    }
                } else if (hasDragged) {
                    console.log("Dragged but dropped outside map area.");
                } else {
                    console.log("Click detected, no drag action.");
                }

                // Collapse FABs only if a tree add was initiated
                if (addedTree) {
                    addFabContainer.classList.remove('expanded');
                }

                // Reset drag state regardless of outcome
                isDragging = false;
                dragTreeType = null;
                hasDragged = false;
                startX = null;
                startY = null;
                offsetX = null;
                offsetY = null;
                draggedOriginalFab = null; // Reset the stored reference
            }


            // --- Event Listeners & Initialization Function ---
            function initializeApp() {
                loadExistingTrees();
                populateSidebarMenu();

                // Sidebar Menu Listeners
                headerMenuBtn.addEventListener('click', openSidebarMenu);
                sidebarCloseBtn.addEventListener('click', closeSidebarMenu);
                document.addEventListener('click', (e) => {
                    if (sidebarMenu && sidebarMenu.classList.contains('open') && !sidebarMenu.contains(e.target) && e.target !== headerMenuBtn && !headerMenuBtn.contains(e.target)) {
                         closeSidebarMenu();
                     }
                });
                categoryTriggers.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetViewId = button.dataset.targetView;
                        showSidebarView(targetViewId);
                    });
                });
                 sidebarBackBtns.forEach(button => {
                     button.addEventListener('click', () => {
                         showSidebarView('sidebar-main-view');
                     });
                 });

                // Bottom Sheet (Form) Listeners
                bottomSheetCloseBtn.addEventListener('click', closeFormSheet);
                cancelFormBtn.addEventListener('click', closeFormSheet);

                // FAB Listeners
                locateFab.addEventListener('click', () => { if (lastKnownLocation) { map.setView(lastKnownLocation, 16, { animate: true }); } else { showNotification("Your location is not available yet."); } });
                addTreeFab.addEventListener('click', (e) => { e.stopPropagation(); addFabContainer.classList.toggle('expanded'); });
                document.addEventListener('click', (e) => { if (!addFabContainer.contains(e.target) && addFabContainer.classList.contains('expanded')) { addFabContainer.classList.remove('expanded'); } });

                // Simulated Drag Listeners
                subFabs.forEach(fab => { fab.addEventListener('mousedown', startDrag); fab.addEventListener('touchstart', startDrag, { passive: false }); });
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('touchmove', dragMove, { passive: false });
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);

                // Form Submit Listener (Handles Add/Edit with refined image logic)
                treeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const editingTreeId = editTreeIdInput.value;
                    const lat = parseFloat(latInput.value); const lng = parseFloat(lngInput.value); const type = typeSelect.value; const species = speciesInput.value; const notes = notesInput.value; const imageFile = imageInput.files[0];
                    let newImageDataUrl = null; // Use a distinct variable for the *new* potential data URL

                    if (!type || !species || isNaN(lat) || isNaN(lng)) { console.error("Validation failed"); showNotification("Error: Please fill required fields."); return; }

                    const processImageAndSave = (saveCallback) => {
                         if (imageFile) { // Only process if a NEW file was selected
                             const reader = new FileReader();
                             reader.onload = (e) => {
                                 newImageDataUrl = e.target.result; // Store the new data URL here
                                 saveCallback();
                             };
                             reader.onerror = (error) => {
                                 console.error("FileReader Error:", error);
                                 showNotification("Error reading image.");
                                 // Optionally decide if you want to proceed without the image or stop
                             };
                             reader.readAsDataURL(imageFile);
                         } else {
                             // No new image file selected, proceed directly to saveCallback
                             // newImageDataUrl remains null in this case
                             saveCallback();
                         }
                    };

                    if (editingTreeId) { // --- Edit Logic ---
                         const treeIndex = trees.findIndex(t => t.id === editingTreeId);
                         if (treeIndex === -1) { console.error("Tree to edit not found"); showNotification("Error: Could not find tree to update."); return; }

                         processImageAndSave(() => { // Pass the callback
                             const treeToUpdate = trees[treeIndex];
                             treeToUpdate.species = species;
                             treeToUpdate.notes = notes;
                             treeToUpdate.location.lat = lat;
                             treeToUpdate.location.lng = lng;
                             treeToUpdate.type = type;

                             // Update image URL *only* if a new image was successfully read
                             if (newImageDataUrl !== null) {
                                 treeToUpdate.imageUrl = newImageDataUrl;
                             }
                             // --- No 'else' needed: If newImageDataUrl is null (no new file selected),
                             // --- the existing treeToUpdate.imageUrl is kept untouched.

                             try {
                                 saveTreesToLocalStorage();
                             } catch (error) {
                                 console.error("LocalStorage Error:", error);
                                 showNotification("Error saving updated data.");
                                 return;
                             }
                             const marker = markers[editingTreeId];
                             if (marker) {
                                 marker.setPopupContent(createPopupContent(treeToUpdate));
                                 // If the popup was open, re-attach listeners after content update
                                 if (marker.isPopupOpen()) {
                                    // Re-binding popup content implicitly handles listener re-attachment via the 'popupopen' event
                                 }
                             }
                             populateSidebarMenu();
                             closeFormSheet();
                             showNotification(`"${species}" tree updated.`);
                         });

                    } else { // --- Add Logic ---
                         processImageAndSave(() => { // Pass the callback
                             const newTree = {
                                 id: Date.now().toString(),
                                 type,
                                 species,
                                 notes,
                                 location: { lat, lng },
                                 imageUrl: newImageDataUrl || '', // Use new URL if available, else empty string
                                 dateAdded: new Date().toISOString(),
                                 needsAttention: false
                             };
                             trees.push(newTree);
                             try {
                                 saveTreesToLocalStorage();
                             } catch (error) {
                                 console.error("LocalStorage Error:", error);
                                 showNotification("Error saving new data.");
                                 return; // Stop if saving failed
                             }
                             addTreeMarker(newTree);
                             populateSidebarMenu();
                             closeFormSheet();
                             showNotification(`"${species}" tree added.`);
                         });
                    }
                }); // End of submit listener


                imageInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (e) => { previewImg.src = e.target.result; imagePreview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { previewImg.src = '#'; imagePreview.classList.add('hidden'); } });

            } // End of initializeApp

            // --- Start the app ---
            initializeApp();

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>